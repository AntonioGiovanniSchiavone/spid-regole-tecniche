Sessioni
========

**Il fornitore di servizi (Service Provider o SP)** *eroga i servizi agli utenti, richiede l'autenticazione agli Identity Provider e gestisce la procedura di autorizzazione al servizio*

Il fornitore di servizi denominato anche con il termine tecnico di Service Provider per la realizzazione
dei profili SSO previsti, SP-Initiated Redirect/POST binding e POST/POST binding, deve
mettere a disposizione le seguenti interfacce:
· IAuthnResponse: ricezione delle risposte di autenticazione SAML;
· IMetadataRetrieve: permette il reperimento dei SAML metadata del Service Provider da
parte dell'Identity Provider.
1.3.1. REGOLE DI PROCESSAMENTO DELLA <RESPONSE>
Alla ricezione <response> qualunque sia il binding utilizzato il Service Provider prima di
utilizzare l'asserzione deve operare almeno le seguenti verifiche:
· controllo delle firme presenti nella <Assertion > e nella <response>;
· nell'elemento <SubjectConfirmationData> verificare che:
- l'attributo Recipient coincida con la assertion consuming service URL a cui la
<Response> è pervenuta;
- l'attributo NotOnOrAfter non sia scaduto;
- l'attributo InResponseTo riferisca correttamente all'ID della <AuthnRequest> di
di richiesta.
Il fornitore di servizi deve garantire che le asserzioni non vengano ripresentate, mantenendo il
set di identificatori di richiesta (ID) usati come per le <AuthnRequest> per tutta la durata di
tempo per cui l'asserzione risulta esser valida in base dell'attributo NotOnOrAfter dell'elemento
<SubjectConfirmationData> presente nell'asserzione stessa.
1.3.2. SP METADATA
Le caratteristiche del Service Provider devono essere definite attraverso metadata conformi allo
standard SAMLv2.0.( cfr. [SAML-Metadata]), e rispettare le condizioni di seguito indicate:
· nell'elemento <EntityDescriptor> devono essere presenti i seguenti attributi:
- entityID: indicante l'identificativo univoco (un URI) dell'entità;
· deve l'elemento <KeyDescriptor> contenenete il certificato della corrispondente
chiave pubblica dell'entità, utile per la verifica della firma dei messaggi prodotti da tale
entità nelle sue interazioni con le altre (cfr.[SAML-Metadata], sez. 2.4.1.1);
· deve essere l'elemento <Signature> riportante la firma sui metadata . La firma deve essere
prodotta secondo il profilo specificato per SAML (cfr. [SAML-Metadata] cap3) utilizzando
chiavi RSA almeno a 1024 bit e algoritmo di digest SHA-256 o superiore;

deve essere presente l'elemento <SPSSODescriptor> riportante i seguenti attributi:
- protocolSupportEnumeration: che enumera, separati da uno spazio, gli URI
associati ai protocolli supportati dall'entità (poiché si tratta di un'entità SAML 2.0,
deve indicare almeno il valore del relativo protocollo:
"urn:oasis:names:tc:SAML:2.0:protocol");
- AuthnRequestSigned: valorizzato true attributo con valore booleano che esprime il
requisito che le richieste di autenticazione inviate dal service provider siano
firmate;
· deve essere presente almeno un elemento <AssertionConsumerService> indicante
il servizio (in termini di URL e relativo binding "HTTP POST") a cui contattare il Service
Provider per l'invio di risposte SAML, riportanti i seguenti attributi:
- index che può assumere valori unsigned;
- Binding posto al valore "urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST"
- Location url endpoint del servizio per la ricezione delle risposte;
In particolare il primo di questi elementi (o l'unico elemento riportato) deve
obbligatoriamente riportare:
- l'attributo index posto al valore 0;
- l'atrtibuto isDefault posto al valore true;
· deve essere presente uno o più elementi <AttributeConsumingService> a
descrizione dei set di attributi richiesti dal Service Provider , riportante:
- l'attributo index, indice posizionale dell'elemento relativo all'i-esimo servizio
richiamato dalla authReq mediante l'attributo
AttributeConsumingServiceIndex dell'elemento <AuthnRequest>;
- l'elemento <ServiceName>, riportante l'identificatore dell'i-esimo set minimo di
attributi necessari1 per l'autorizzazione all'acceso;
- uno o più elementi di tipo <RequestedAttribute>, ciascuno di essi
costituente la lista degli attributi associati all'i-esimo servizio;
· è consigliata la presenza di un elemento <Organization> a indicare l'organizzazione a
cui afferisce l'entità specificata, riportante gli elementi:
- <OrganizationName> indicante un identificatore language-qualified
dell'organizzazione a cui l'entità afferisce;
- <OrganizationURL> riportante in modalità language-qualified la url
istituzionale dell'organizzazione.

*Per la massima tutela della privacy dell'utente il service provider deve rendere minima la visibilità dei servizi effettivamente
invocati. In questa logica occorre rendere ove possibile indifferenziate le richieste relative a servizi che condividono lo
stesso set minimo di attributi necessari per l'autorizzazione.*

I metadata Services Provider saranno disponibili per tutte le entità SPID federate attraverso
l'interfaccia IMetadataRetrive alla URL < dominioServiceProvider >/metadata e saranno firmate
dell' Agenzia per l'Italia Digitale. L'accesso deve essere effettuato utilizzando il protocollo TLS
nella versione più recente disponibile.

.. literalinclude:: code-samples/sp-metadata.xml
   :language: xml
   :linenos:
